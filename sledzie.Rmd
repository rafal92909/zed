---
title: "¦ledzie"
author: "Rafal Meller 106450"
date: "`r format(Sys.time(), '%d %B %Y')`"
always_allow_html: yes
output:
  html_document:
    keep_md: yes
    number_sections: yes
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



# Podsumowanie
Analiza ma na celu odpowied¼ na pytanie dlaczego rozmiar ¶ledzia w pewnym momencie zacz±³ maleæ. <br />
Analizowany zbiór danych zawiera prawie 53 tys. rekordóW, które zosta³y zebrane na przestrzeni ostatnich 60 lat. Niestyty, w przypadku a¿ 20% rekordów brakowa³o warto¶ci niektórych atrybutów, które zosta³y uzupe³nione warto¶ciami ¶rednimi danego atrybutu.<br />
W zbiorze wystêpuje silna korelacja trzech par atrybutów (chel1 i lcop1, chel2 i lcop2, cumf i fbar). Ze wzglêdu na korelacjê, zbiór danych zosta³ odchudzony o trzy atrybuty (chel1,chel2, fbar).<br />
Nastêpnie, wykonana zosta³a regresja, która przewiduje zmianê rozmiaru ¶ledzia w czasie oraz przeprowadzona zosta³a analiza wa¿no¶ci atrybutów.
Analiza ta, pokazuje, ¿e bezpo¶redni wp³yw na spadek d³ugo¶ci ¶ledzia ma miesi±c po³owu, a tak¿e dostêpno¶æ okre¶lonych gatunkóW planktou (Calanus finmarchicus gat. 2 oraz wid³onogów gat. 1) oraz temperatura wody zmierzona tu¿ przy jej powierzchni.


# Kod wyliczaj±cy wykorzystane biblioteki:

```{r biblioteki, results='hide', message=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(plotly)
library(mice)
library(knitr)
library(corrplot)
library(randomForest)
library(caret)
```



# Kod zapewniaj±cy powtarzalno¶æ wyników przy ka¿dym uruchomieniu raportu na tych samych danych:

```{r setSeed}
set.seed(67)
```



# Kod pozwalaj±cy wczytaæ dane z pliku:

```{r readCsvSledzie}
sledzie <-read.csv("sledzie.csv", sep = ",", na.strings = "?", header = TRUE)
```



# Kod przetwarzaj±cy brakuj±ce dane.

``` {r echo=FALSE}
ile_sledzi <- nrow(sledzie)
sledzie_NA <- sledzie[rowSums(is.na(sledzie)) > 0,]
ile_sledzi_NA <- nrow(sledzie_NA)
```

W zbiorze danych liczba wszystkich rekordów wynosi:
``` {r echo=FALSE}
ile_sledzi
```
W zbiorze danych liczba rekordów, które zawieraj± warto¶æ NA wynosi:
``` {r echo=FALSE}
ile_sledzi_NA
```
Nie mo¿emy usun±æ rekordów z warto¶ciami pustymi poniewa¿ stanowi± one prawie 20% ca³ego zbioru.
``` {r echo=FALSE}
paste(round(ile_sledzi_NA/ile_sledzi*100, digits = 2), "%")
```
Dane przedstawione poni¿ej pokazuj± ilo¶æ warto¶ci NA w ka¿dej z kolumn w procentach:
```{r ileBrakujacych, echo=FALSE}
ileBrakujacych <- function(zbior){
  i <- sum(is.na(zbior))/length(zbior)*100
  paste(round(i, digits = 2), "%")
}
kable(apply(sledzie,2,ileBrakujacych))
```
<br /><br />
W kolumnach, w których wystêpuj± warto¶ci puste, ilo¶æ NA oscyluje w okolicach 3%, a wiêc nie ma potrzeby usuwania ¿adnej z kolumn z procesu analizy danych. 
<br />
Poni¿szy wykres przedstawia ilo¶æ warto¶ci pustych w ka¿dej z kolumn.

```{r ile_na_wykres, echo=FALSE}
ile <- sledzie %>%
  gather(nazwa_kolumny, wartosc, 1:ncol(sledzie)) %>%
  filter(is.na(wartosc))

ggplot(ile, aes(factor(nazwa_kolumny))) +
  geom_bar() +
  labs(
      title = "Ilo¶æ brakuj±cych warto¶ci w ka¿dej z kolumn", 
      x = "Nazwa kolumny", 
      y = "Ilo¶æ brakuj±cych warto¶ci") + 
  theme_bw()

```
<br /><br /><br />Brakuj±ce warto¶ci zostan± uzupe³nione przy u¿yciu funkcji mice nale¿±cej do pakietu mice. Funkcja zastêpuje brakuj±ce elementy warto¶ci± ¶redni± kolumny, w której dana warto¶æ pusta siê znajduje. 

```{r usun_braki, results='hide', message=FALSE, echo=FALSE}
# https://datascienceplus.com/imputing-missing-data-with-r-mice-package/
sledzie <- mice(sledzie, m=1, method='mean', seed=67, echo=FALSE)
sledzie <- complete(sledzie, 1)

```



# Sekcja podsumowuj±c± rozmiar zbioru i podstawowe statystyki.

``` {r echo=FALSE}
kable(summary(sledzie))
```



# Analiza atrybutów

Zbiór danych sk³ada siê z 15 atrybutów. Opisuj± one:
<ul>
<li>d³ugo¶æ z³owionego ¶ledzia (length),</li>
<li>dostêpno¶æ planktonu (cfin1, cfin2, chel1, chel2, lcop1, lcop2),</li>
<li>narybek (fbar, recr, cumf),</li>
<li>³±czn± liczbê z³owionych ryb w ramach po³owu (totaln)</li>
<li>wodê (sst, sal, nao),</li>
<li>miesi±c po³owu (xmonth).</li>
</ul>



# Sekcja sprawdzaj±ca korelacje miêdzy zmiennymi
 
``` {r echo=FALSE}
sledzie_korelacja <- select(sledzie, -c(X))
korelacja <- cor(sledzie_korelacja)
corrplot(korelacja, method="number")
```
<br /><br />
``` {r echo=FALSE}
ggplot(sledzie, aes(chel1, lcop1)) + 
  geom_point() + 
  labs(title = "Korelacja pomiêdzy chel1 i lcop1") + 
  geom_smooth(method="glm") +
  theme_bw()
```
<br /><br />
``` {r echo=FALSE}
ggplot(sledzie, aes(chel2, lcop2)) + 
  geom_point() + 
  labs(title = "Korelacja pomiêdzy chel2 i lcop2") + 
  geom_smooth(method="glm") + 
  theme_bw()
```
<br /><br />
``` {r echo=FALSE}
ggplot(sledzie, aes(fbar, cumf)) + 
  geom_point() + 
  labs(title = "Korelacja pomiêdzy fbar i cumf") + 
  geom_smooth(method="glm") +
  theme_bw()
```
<br /><br />
 Z powy¿szych wykresów mo¿na zaobserwowaæ, ¿e najbardziej skorelowanyne ze sob± s± pary atrybutów:
 <ul>
 <li>chel1 i lcop1</li>
 <li>chel2 i lcop2</li>
 <li>fbar i cumf</li>
 </ul>
 
 Na tej podstawie mo¿emy usun±æ trzy atrybuty (chel1, chel2, fbar) z przetwarzanego zbioru danych/
``` {r echo=FALSE} 
 sledzie <- select(sledzie, -c(chel1,chel2, fbar))
```
 

 
# Zmiana rozmiaru ¶ledzia w czasie - wykres interaktywny

``` {r sledz_w_czasie, message=FALSE, echo=FALSE }

sledzie_interaktywne <- ggplot(sledzie, aes(x=X, y=length)) + 
  geom_smooth() + 
  labs(
    title = "Zmiana rozmiaru ¶ledzia w czasie", 
    x = "Czas", 
    y = "Rozmiar ¶ledzia [cm]") +
  theme_bw()
ggplotly(sledzie_interaktywne)
```



# Regresor przewiduj±cy rozmiar ¶ledzia

W naszym przypadku regresja ma za zadanie stworzyæ model, który bêdzie przewidywa³ d³ugo¶æ ¶ledzi w czasie.
Dane wej¶copwe s± oczyszczone z warto¶ci pustych, a atrybuty chel1,chel2, fbar usuniête, ze wzglêdu na siln± korelacjê.
Zbiór danych podzielony zosta³ na dane ucz±ce, waliduj±ce i testowe.
Tak przygotowe dane zostan± poddane procesowi uczenia przy pomocy algorytmu random forest.
``` {r regresja, echo=FALSE}
inT <- createDataPartition(y = sledzie$length, p = .7, list = FALSE)

sledzie_treningowe <- sledzie[inT, ]
sledzie_treningowe <- select(sledzie_treningowe, -X)
sledzie_testowe <- sledzie[-inT, ]

ctrl <- trainControl(method = "repeatedcv", number = 2, repeats = 5)
rfFit <- train(length ~ .,
  data = sledzie_treningowe,
  method = "rf",
  trControl = ctrl,
  importance = TRUE,
  ntree = 10)

sledzie_testowe2 <- select(sledzie_testowe, -c(X, length))
przewidywania <- predict(rfFit, sledzie_testowe2)
```
<br />
Trafno¶æ rekgrasji zosta³a oszacowana na podstawie miar R<sup>2</sup> i RMSE.
``` {r regresja_oszacowanie, echo=FALSE}
kable(postResample(pred = przewidywania, obs = sledzie_testowe$length))
```
<br /><br /><br />
Poni¿szy wykres przedstawia przewidywan± zmianê d³ugo¶ci ¶ledzia w czasie.
``` {r regresja_wykres, echo=FALSE, message=FALSE}
ggplot(data.frame(Length = przewidywania),aes(x = 1:length(Length), y=Length)) + 
  geom_smooth() +
  coord_cartesian(ylim = c(24, 27)) +
    labs(
    title = "Zmiana rozmiaru ¶ledzia w czasie - predykcja", 
    x = "Czas", 
    y = "Rozmiar ¶ledzia [cm]") +
  theme_bw()
```



# Analiza wa¿no¶ci atrybutów 

Analiza wa¿no¶ci atrybutóW dowodzi, ¿e najwiêkszy wp³yw na spadek d³ugo¶ci ¶ledzia ma miesi±c po³owu. Znacz±cy wp³ywa ma równie¿ dostêpno¶æ planktonów Calanus finmarchicus gat. 2 oraz wid³onogów gat. 1, a tak¿e temperatura przy powiedzchni wody. <br />Natomiast na d³ugo¶æ ¶ledzia nie ma wp³ywu roczny narybek ani oscylacja pó³nocnoatlantycka. Reszta atrybutów ma znikomy wp³yw.
```{r waznosc, echo=FALSE}
waznosc <- varImp(rfFit)
waznosc
plot(waznosc)
```
